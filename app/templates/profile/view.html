{% extends "base.html" %}

{% block title %}{% if user %}{{ user.name }}'s Profile{% else %}My Profile{% endif %} - CommUnity{% endblock %}

{% block content %}
{% set profile_user = user if user else current_user %}
{% set is_own = not user or user.id == current_user.id %}

<!-- Header with Cover Photo -->
<div class="relative">
    <!-- Cover Photo -->
    <div class="h-48 lg:h-64 bg-gradient-to-r from-primary to-blue-600 relative group {% if profile_user.cover_photo %}bg-cover bg-center{% endif %}" {% if profile_user.cover_photo %}style="background-image: url('{{ profile_user.cover_photo }}');"{% endif %}>
        {% if is_own %}
        <label for="coverPhotoInput" class="absolute top-4 right-4 bg-white bg-opacity-0 group-hover:bg-opacity-90 rounded-full p-2 lg:p-3 shadow-lg transition-all cursor-pointer opacity-0 group-hover:opacity-100">
            <span class="material-symbols-rounded text-xl lg:text-2xl text-gray-700">photo_camera</span>
            <input type="file" id="coverPhotoInput" accept="image/*" class="hidden" onchange="uploadCoverPhoto(event)">
        </label>
        {% endif %}
    </div>
    
    <!-- Profile Info Section -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="relative -mt-16 lg:-mt-20 mb-6">
            <div class="flex flex-col sm:flex-row items-center sm:items-end gap-4">
                <!-- Avatar -->
                <div class="relative">
                    <img src="{% if profile_user.profile_picture %}{{ profile_user.profile_picture }}{% else %}https://ui-avatars.com/api/?name={{ profile_user.name or 'User' }}&size=160&background=1392ec&color=fff{% endif %}" 
                         alt="Profile" 
                         id="profileImage"
                         class="w-32 h-32 lg:w-40 lg:h-40 rounded-full border-4 border-white shadow-lg object-cover">
                    {% if is_own %}
                    <label for="avatarInput" class="absolute bottom-0 right-0 bg-primary hover:bg-blue-700 rounded-full p-2 lg:p-2.5 shadow-lg transition-colors cursor-pointer">
                        <span class="material-symbols-rounded text-lg lg:text-xl text-white">edit</span>
                        <input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="uploadAvatar(event)">
                    </label>
                    {% endif %}
                </div>
                
                <!-- Name and Stats -->
                <div class="flex-1 text-center sm:text-left sm:ml-4 sm:mb-4">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2">
                        <h1 class="text-2xl lg:text-3xl font-bold text-gray-900">{{ profile_user.name or 'User' }}</h1>
                        {% if is_own %}
                        <a href="{{ url_for('profile.edit_profile') }}" 
                           class="inline-flex items-center gap-2 bg-primary hover:bg-blue-700 text-white px-4 lg:px-5 py-2 lg:py-2.5 rounded-xl transition-colors text-sm lg:text-base font-medium">
                            <span class="material-symbols-rounded text-lg lg:text-xl">edit</span>
                            Edit Profile
                        </a>
                        {% endif %}
                    </div>
                    
                    {% if profile_user.location %}
                    <div class="flex items-center justify-center sm:justify-start gap-2 text-sm lg:text-base text-gray-600 mb-3">
                        <span class="material-symbols-rounded text-lg lg:text-xl">location_on</span>
                        <span>{{ profile_user.location }}</span>
                    </div>
                    {% endif %}
                    
                    <p class="text-sm lg:text-base text-gray-600 max-w-2xl">
                        {% if profile_user.bio %}
                            {{ profile_user.bio }}
                        {% else %}
                            {% if is_own %}
                            Welcome to the community! Update your bio to tell others about yourself.
                            {% else %}
                            No bio available.
                            {% endif %}
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        {% if is_own %}
        <!-- Quick Actions -->
        <div class="mb-6">
            <h2 class="text-lg font-bold text-gray-900 mb-3">Quick Actions</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <a href="/events/my-events" class="group bg-gradient-to-r from-primary to-blue-600 hover:from-primary/90 hover:to-blue-600/90 text-white p-5 rounded-2xl transition-all shadow-sm hover:shadow-md">
                    <div class="flex items-center gap-3">
                        <div class="flex items-center justify-center w-12 h-12 rounded-xl bg-white/20">
                            <span class="material-symbols-outlined text-2xl">event_available</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-lg">My Events</div>
                            <div class="text-sm text-white/80">View going, interested & saved</div>
                        </div>
                        <span class="material-symbols-outlined text-2xl opacity-50 group-hover:opacity-100 transition-opacity">arrow_forward</span>
                    </div>
                </a>
                
                <a href="/profile/edit" class="group bg-white dark:bg-surface-dark hover:bg-slate-50 dark:hover:bg-slate-800 border border-slate-200 dark:border-slate-700 p-5 rounded-2xl transition-all shadow-sm hover:shadow-md">
                    <div class="flex items-center gap-3">
                        <div class="flex items-center justify-center w-12 h-12 rounded-xl bg-slate-100 dark:bg-slate-800">
                            <span class="material-symbols-outlined text-2xl text-slate-700 dark:text-slate-300">settings</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-lg text-gray-900 dark:text-white">Settings</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Edit profile & preferences</div>
                        </div>
                        <span class="material-symbols-outlined text-2xl text-slate-400 group-hover:text-slate-600 transition-colors">arrow_forward</span>
                    </div>
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Stats Cards -->
        <div class="mb-6">
            <h2 class="text-lg font-bold text-gray-900 mb-3">Statistics</h2>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
                <a href="{% if is_own %}/events/my-events{% else %}#{% endif %}" class="bg-surface-light rounded-2xl p-4 lg:p-5 shadow-sm text-center {% if is_own %}hover:shadow-md transition-all hover:scale-105 cursor-pointer{% endif %}">
                    <div class="text-2xl lg:text-3xl font-bold text-primary mb-1">{{ stats.events_attended }}</div>
                    <div class="text-sm lg:text-base text-gray-600">Events Attended</div>
                </a>
                <div class="bg-surface-light rounded-2xl p-4 lg:p-5 shadow-sm text-center">
                    <div class="text-2xl lg:text-3xl font-bold text-green-600 mb-1">{{ stats.groups_joined }}</div>
                    <div class="text-sm lg:text-base text-gray-600">Groups Joined</div>
                </div>
                <div class="bg-surface-light rounded-2xl p-4 lg:p-5 shadow-sm text-center">
                    <div class="text-2xl lg:text-3xl font-bold text-orange-600 mb-1">{{ stats.issues_reported }}</div>
                    <div class="text-sm lg:text-base text-gray-600">Issues Reported</div>
                </div>
                <div class="bg-surface-light rounded-2xl p-4 lg:p-5 shadow-sm text-center">
                    <div class="text-2xl lg:text-3xl font-bold text-purple-600 mb-1">{{ stats.reputation_points }}</div>
                    <div class="text-sm lg:text-base text-gray-600">Reputation Points</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content Tabs -->
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pb-24">
    
    <!-- Tab Navigation -->
    <div class="bg-background-light pt-4 pb-2 mb-6">
        <div class="flex gap-2 overflow-x-auto hide-scrollbar border-b border-gray-200">
            <button onclick="switchTab('interests')" 
                    class="tab-btn active px-4 lg:px-5 py-3 lg:py-3.5 font-medium whitespace-nowrap text-sm lg:text-base border-b-2 transition-colors">
                Interests
            </button>
            <button onclick="switchTab('badges')" 
                    class="tab-btn px-4 lg:px-5 py-3 lg:py-3.5 font-medium whitespace-nowrap text-sm lg:text-base border-b-2 transition-colors">
                Badges
            </button>
            <button onclick="switchTab('activity')" 
                    class="tab-btn px-4 lg:px-5 py-3 lg:py-3.5 font-medium whitespace-nowrap text-sm lg:text-base border-b-2 transition-colors">
                Activity
            </button>
        </div>
    </div>

    <!-- Interests Tab -->
    <div id="interests-tab" class="tab-content">
        <div class="bg-surface-light rounded-2xl p-5 lg:p-6 shadow-sm mb-4">
            <h2 class="text-lg lg:text-xl font-bold text-gray-900 mb-4">{% if is_own %}My{% else %}{{ profile_user.name }}'s{% endif %} Interests</h2>
            {% if profile_user.interests and profile_user.interests|length > 0 %}
            <div class="flex flex-wrap gap-2 lg:gap-3">
                {% for interest in profile_user.interests %}
                <span class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full text-sm lg:text-base font-medium">{{ interest }}</span>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-600 text-sm lg:text-base">{% if is_own %}No interests added yet. Edit your profile to add your interests!{% else %}No interests listed.{% endif %}</p>
            {% endif %}
        </div>

        <div class="bg-surface-light rounded-2xl p-5 lg:p-6 shadow-sm">
            <h2 class="text-lg lg:text-xl font-bold text-gray-900 mb-4">Member Since</h2>
            <div class="flex items-center gap-3 text-gray-600">
                <span class="material-symbols-rounded text-2xl lg:text-3xl text-primary">calendar_today</span>
                <div>
                    <p class="text-base lg:text-lg font-medium text-gray-900">December 2024</p>
                    <p class="text-sm lg:text-base text-gray-500">Active for 1 month</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Badges Tab -->
    <div id="badges-tab" class="tab-content hidden">
        {% if badges and badges|length > 0 %}
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            {% set badge_info = {
                'first_steps': {'emoji': 'üåü', 'color': 'yellow', 'name': 'First Steps', 'desc': 'Joined the community'},
                'event_explorer': {'emoji': 'üéâ', 'color': 'blue', 'name': 'Event Explorer', 'desc': 'Attended 10 events'},
                'community_builder': {'emoji': 'ü§ù', 'color': 'green', 'name': 'Community Builder', 'desc': 'Joined 5 groups'},
                'problem_solver': {'emoji': 'üõ†Ô∏è', 'color': 'orange', 'name': 'Problem Solver', 'desc': 'Reported 10 issues'},
                'conversation_starter': {'emoji': 'üí¨', 'color': 'purple', 'name': 'Conversation Starter', 'desc': 'Posted 50 comments'},
                'super_star': {'emoji': '‚≠ê', 'color': 'pink', 'name': 'Super Star', 'desc': 'Reached 1000 reputation points'},
                'event_host': {'emoji': 'üé™', 'color': 'indigo', 'name': 'Event Host', 'desc': 'Created an event'},
                'group_creator': {'emoji': 'üë•', 'color': 'teal', 'name': 'Group Creator', 'desc': 'Created a group'},
                'helpful_neighbor': {'emoji': 'üè°', 'color': 'emerald', 'name': 'Helpful Neighbor', 'desc': 'Active in community discussions'}
            } %}
            
            {% for badge in badges %}
            {% set info = badge_info.get(badge.badge_type, {'emoji': 'üèÜ', 'color': 'gray', 'name': badge.badge_type, 'desc': 'Achievement unlocked'}) %}
            <div class="bg-surface-light rounded-2xl p-5 lg:p-6 shadow-sm text-center hover:shadow-md transition-shadow">
                <div class="w-16 h-16 lg:w-20 lg:h-20 bg-{{ info.color }}-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <span class="text-3xl lg:text-4xl">{{ info.emoji }}</span>
                </div>
                <h3 class="font-bold text-gray-900 text-sm lg:text-base mb-1">{{ info.name }}</h3>
                <p class="text-xs lg:text-sm text-gray-600">{{ info.desc }}</p>
                <p class="text-xs text-gray-400 mt-2">Earned {{ badge.earned_at|timeago }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-rounded text-5xl text-gray-400">workspace_premium</span>
            </div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">No Badges Yet</h3>
            <p class="text-gray-600">Start participating in the community to earn badges!</p>
            <div class="mt-6 space-y-2 text-sm text-gray-500">
                <p>‚Ä¢ Attend events to earn <strong>Event Explorer</strong></p>
                <p>‚Ä¢ Join groups to earn <strong>Community Builder</strong></p>
                <p>‚Ä¢ Report issues to earn <strong>Problem Solver</strong></p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Activity Tab -->
    <!-- Activity Tab -->
    <div id="activity-tab" class="tab-content hidden">
        {% if activity and activity|length > 0 %}
        <div class="space-y-4">
            {% for item in activity %}
            <div class="bg-surface-light rounded-2xl p-5 lg:p-6 shadow-sm">
                <div class="flex gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 lg:w-14 lg:h-14 
                            {% if item.activity_type == 'event_rsvp' or item.activity_type == 'event_attended' %}bg-blue-100{% elif item.activity_type == 'group_joined' %}bg-green-100{% elif item.activity_type == 'issue_reported' %}bg-orange-100{% elif item.activity_type == 'badge_earned' %}bg-purple-100{% else %}bg-gray-100{% endif %}
                            rounded-full flex items-center justify-center">
                            <span class="material-symbols-rounded 
                                {% if item.activity_type == 'event_rsvp' or item.activity_type == 'event_attended' %}text-blue-600{% elif item.activity_type == 'group_joined' %}text-green-600{% elif item.activity_type == 'issue_reported' %}text-orange-600{% elif item.activity_type == 'badge_earned' %}text-purple-600{% else %}text-gray-600{% endif %}
                                text-xl lg:text-2xl">
                                {% if item.activity_type == 'event_rsvp' or item.activity_type == 'event_attended' %}event{% elif item.activity_type == 'group_joined' %}groups{% elif item.activity_type == 'issue_reported' %}report{% elif item.activity_type == 'badge_earned' %}star{% else %}check_circle{% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm lg:text-base text-gray-900 mb-1">{{ item.description }}</p>
                        <p class="text-xs lg:text-sm text-gray-500">{{ item.created_at|timeago if item.created_at else 'Recently' }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-surface-light rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-rounded text-gray-400 text-3xl">history</span>
            </div>
            <p class="text-gray-600">No activity yet. Start exploring events and groups!</p>
        </div>
        {% endif %}
    </div>

</div>

<!-- Bottom Navigation -->
<div class="fixed bottom-0 left-0 right-0 bg-surface-light border-t border-gray-200 z-40">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-around items-center h-16 lg:h-20">
            <a href="{{ url_for('main.dashboard') }}" class="flex flex-col items-center gap-1 text-gray-500 hover:text-primary transition-colors">
                <span class="material-symbols-rounded text-2xl lg:text-3xl">home</span>
                <span class="text-xs lg:text-sm font-medium">Home</span>
            </a>
            <a href="{{ url_for('events.list_events') }}" class="flex flex-col items-center gap-1 text-gray-500 hover:text-primary transition-colors">
                <span class="material-symbols-rounded text-2xl lg:text-3xl">event</span>
                <span class="text-xs lg:text-sm font-medium">Events</span>
            </a>
            <a href="{{ url_for('issues.report_issue') }}" class="flex flex-col items-center gap-1 text-gray-500 hover:text-primary transition-colors">
                <span class="material-symbols-rounded text-2xl lg:text-3xl">report</span>
                <span class="text-xs lg:text-sm font-medium">Report</span>
            </a>
            <a href="{{ url_for('groups.list_groups') }}" class="flex flex-col items-center gap-1 text-gray-500 hover:text-primary transition-colors">
                <span class="material-symbols-rounded text-2xl lg:text-3xl">groups</span>
                <span class="text-xs lg:text-sm font-medium">Groups</span>
            </a>
            <a href="{{ url_for('profile.view_profile') }}" class="flex flex-col items-center gap-1 text-primary transition-colors">
                <span class="material-symbols-rounded text-2xl lg:text-3xl fill-current">person</span>
                <span class="text-xs lg:text-sm font-medium">Profile</span>
            </a>
        </div>
    </nav>
</div>

<style>
    .tab-btn {
        color: #6b7280;
        border-color: transparent;
    }
    
    .tab-btn.active {
        color: #1392ec;
        border-color: #1392ec;
    }
    
    .tab-btn:hover {
        color: #1392ec;
    }
</style>

<script>
    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(tabName + '-tab').classList.remove('hidden');
        
        // Add active class to clicked button
        event.target.classList.add('active');
    }

    async function uploadAvatar(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size must be less than 5MB');
            return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('profileImage').src = e.target.result;
        };
        reader.readAsDataURL(file);

        // Upload to backend
        const formData = new FormData();
        formData.append('avatar', file);

        try {
            const response = await fetch('/profile/api/upload-avatar', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                // Show success message
                showNotification('Profile picture updated successfully!', 'success');
            } else {
                alert('Upload failed: ' + result.error);
                // Revert preview on error
                location.reload();
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Failed to upload image. Please try again.');
            location.reload();
        }
    }

    async function uploadCoverPhoto(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size must be less than 5MB');
            return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = (e) => {
            const coverDiv = document.querySelector('[style*="background-image"]');
            if (coverDiv) {
                coverDiv.style.backgroundImage = `url('${e.target.result}')`;
            }
        };
        reader.readAsDataURL(file);

        // Upload to backend
        const formData = new FormData();
        formData.append('cover', file);

        try {
            const response = await fetch('/profile/api/upload-cover', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                // Show success message
                showNotification('Cover photo updated successfully!', 'success');
            } else {
                alert('Upload failed: ' + result.error);
                // Revert preview on error
                location.reload();
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Failed to upload image. Please try again.');
            location.reload();
        }
    }

    function showNotification(message, type) {
        // Simple notification - you can enhance this later
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        } text-white`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
</script>

{% endblock %}
